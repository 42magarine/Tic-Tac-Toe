<%- include('components/header', { title: "TicTacToe Game" }) %>

	<div class="flex flex-col items-center justify-center">
		<h1 class="text-4xl font-bold mb-10 text-yellow-300">Current player: <%= currentPlayer %>
		</h1>

		<div class="gameBoard w-96 h-96 grid grid-cols-3 grid-rows-3 gap-2 mx-auto mb-8">
			<% for(let i=0; i < board.length; i++) { %>
				<div class="cell bg-yellow-100 text-gray-900 flex items-center justify-center text-5xl font-bold cursor-pointer hover:bg-yellow-200 transition-colors rounded-md"
					data-index="<%= i %>">
					<%= board[i] %>
				</div>
				<% } %>
		</div>

		<button
			class="restartButton mt-8 px-6 py-3 text-xl font-bold bg-yellow-500 text-gray-900 rounded-lg hover:bg-yellow-600 transition-colors focus:outline-none focus:ring-2 focus:ring-yellow-400">
			Restart Game
		</button>
	</div>

	<script>
		// WebSocket connection
		const socket = new WebSocket(`ws://${window.location.host}/ws`);
		const headerTitle = document.querySelector("h1");
		const cells = document.querySelectorAll(".cell");
		const restartButton = document.querySelector(".restartButton");

		// Handle WebSocket events
		socket.addEventListener("open", () => {
			console.log("Connected to WebSocket server");
		});

		socket.addEventListener("message", (event) => {
			const data = JSON.parse(event.data);
			console.log("Received message:", data);

			if (data.type === "initBoard" || data.type === "resetBoard") {
				updateBoard(data.board);
				updateStatus("Current player: " + (data.player || "x"));
			}
			else if (data.type === "updateBoard") {
				updateBoard(data.board);

				if (data.win) {
					updateStatus(`${data.player} wins!`);
				}
				else if (data.draw) {
					updateStatus("It's a draw!");
				}
				else {
					updateStatus(`Current player: ${data.player}`);
				}
			}
		});

		// Update board based on server state
		function updateBoard(board) {
			cells.forEach((cell, index) => {
				cell.textContent = board[index];
			});
		}

		// Update game status message
		function updateStatus(message) {
			headerTitle.textContent = message;
		}

		// Cell click handler
		document.querySelector(".gameBoard").addEventListener("click", (event) => {
			const target = event.target;
			if (target.classList.contains("cell")) {
				const index = Number(target.dataset.index);
				socket.send(JSON.stringify({ type: "makeMove", index }));
			}
		});

		// Restart button handler
		restartButton.addEventListener("click", () => {
			socket.send(JSON.stringify({ type: "resetGame" }));
		});
	</script>

	<%- include('components/footer') %>